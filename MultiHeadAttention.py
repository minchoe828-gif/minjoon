class MultiHeadAttention(d2l.Module):
    def __init__(self,num_hiddens, num_heads, dropout, bias=False):
        self.num_heads = num_heads
        self.attention = d2l.DotProductAttention(dropout)
        self.W_q = nn.LazyLinear(num_hiddens, bias=bias)
        self.W_k = nn.LazyLinear(num_hiddens, bias=bias)
        self.W_v = nn.LazyLinear(num_hiddens, bias=bias)
        self.W_o = nn.LazyLinear(num_hiddens, bias=bias)
    
    def forward(self, queries, keys, values, valid_lens):
        queries = self.transpose_qkv(self.W_q(queries))
        keys = self.transpose_qkv(self.W_k(keys))
        values = self.transpose_qkv(self.W_v(values))
        if valid_lens is not None:
            valid_lens = torch.repeat_interleave(
                valid_lens, repeats=self.num_heads, dim=0)
            
        output = self.attention(queries, keys, values, valid_lens)
        output_concat = self.transpose_output(output)
        return self.W_o(output_concat)

    def transpose_qkv(self,X):
        X=X.reshape(X.shape[0], X.shape[1], num_heads, -1)
        X=X.permute(0,2,1,3)
        X=X.reshape(-1, X.shape[2], X.shape[-1])
        return X

    def transpose_output(self, X):
        X=X.reshape(-1, num_heads, X.shape[2], X.shape[3])
        X=X.permute(0,2,1,3)
        X=X.reshape(X.shape[0], X.shape[1], -1)
        return X 
        
